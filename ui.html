<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Frame to PPT Converter</title>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.9.0/dist/pptxgen.bundle.js"></script>
  </head>
  <body>
    <h3>Convert Figma Frames to PowerPoint</h3>
    <button id="convert-btn">Convert Selected Frames</button>
    <div id="status"></div>

    <script>
      const convertBtn = document.getElementById('convert-btn');
      const statusDiv = document.getElementById('status');

      convertBtn.onclick = () => {
        statusDiv.textContent = "Processing...";
        // Ask Figma for frame data
        parent.postMessage({ pluginMessage: { type: 'request-frame-data' } }, '*');
      };

      window.onmessage = async (event) => {
        const msg = event.data.pluginMessage;
        if (msg.type === 'frame-data-array') {
          const frameDataArray = msg.frameDataArray;
          generatePPT(frameDataArray);
        }
      };

      // Function to convert image bytes to Base64
      function convertBytesToBase64(bytes) {
        return new Promise((resolve) => {
          const blob = new Blob([new Uint8Array(bytes)], { type: 'image/png' });
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      }

      // Process frame data and convert image bytes to Base64
      async function processFrameData(frameData) {
        const processedData = [];

        for (const element of frameData) {
          if (element.type === "IMAGE") {
            const base64Image = await convertBytesToBase64(element.imageBytes);
            processedData.push({ ...element, imageBase64: base64Image });
          } else {
            processedData.push(element);
          }
        }

        return processedData;
      }

      // Function to generate the PowerPoint file using pptxgenjs
      async function generatePPT(frameDataArray) {
        const pptx = new PptxGenJS();
        const scaleFactor = 0.75; // Scale all text elements by 75%

        // Iterate over all frames and create a slide for each frame
        for (const frameData of frameDataArray) {
          const slide = pptx.addSlide();
          const processedFrameData = await processFrameData(frameData);

          processedFrameData.forEach((element) => {
            if (element.type === "TEXT") {
              // Convert Figma RGB to Hex
              const color = element.fontColor || "#000000"; // Default to black
              const fontFace = element.fontName || "Arial"; // Default font family
              const fontWeight = element.fontWeight > 600 ? "bold" : "normal";
              
              // Scale font size, width, and height by 0.75
              const scaledFontSize = element.fontSize * scaleFactor;
              const scaledWidth = element.width + 16;
              const scaledHeight = element.height;

              slide.addText(element.text, {
                x: element.x / 96, // Convert from pixels to inches
                y: element.y / 96,
                w: scaledWidth / 82,  // Scale the width
                h: scaledHeight / 96,  // Scale the height
                fontSize: scaledFontSize,  // Scale the font size
                fontFace: fontFace, // Use Figma's font or fallback to Arial
                color: color, // Set the color
                bold: fontWeight === "bold", // Set bold if fontWeight is 700
                autoFit: false, // Disable text auto-fit to avoid wrapping
                isTextBox: true // Force text to fit within the defined box
              });
            } else if (element.type === "IMAGE") {
              slide.addImage({
                data: element.imageBase64,
                x: element.x / 96,
                y: element.y / 96,
                w: element.width / 96,
                h: element.height / 96
              });
            }
          });
        }

        // Generate the PPTX file and trigger download
        pptx.write('blob').then((pptBlob) => {
          const link = document.createElement('a');
          const url = URL.createObjectURL(pptBlob);
          link.href = url;
          link.download = 'presentation.pptx';
          link.click();

          statusDiv.textContent = "PPTX file generated!";
        });
      }

      // Helper function to convert RGB color to Hex
      function rgbToHex(r, g, b) {
        r = Math.round(r * 255);
        g = Math.round(g * 255);
        b = Math.round(b * 255);
        return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
      }
    </script>
  </body>
</html>
